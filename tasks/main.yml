---
- name: "Install dependencies: dnf-plugins-core, yum-utils"
  ansible.builtin.package:
    name: 
      - dnf-plugins-core
      - yum-utils
  become: true
  register: INSTALL_POWERTOOLS
  ignore_errors: true
- name: "Install RHEL8 codeready"
  shell: "subscription-manager repos --enable codeready-builder-for-rhel-8-x86_64-rpms"
  become: true
  when: ansible_distribution == 'RedHat'
- name: "Install dependencies: dnf-plugins-core, yum-utils"
  shell: "pkcon install -y {{ item }} | true"
  loop:
    - dnf-plugins-core
    - yum-utils
  when: ansible_distribution != 'RedHat' and INSTALL_POWERTOOLS.failed
- name: "Enable powertools repo"
  shell: "yum-config-manager --enable powertools"
  ignore_errors: true
  become: true
  register: ENABLE_POWERTOOLS
  when: ansible_distribution != 'RedHat'
- name: "Enable powertools repo"
  shell: "pkcon repo-enable powertools"
  ignore_errors: true
  become: true
  when: ansible_distribution != 'RedHat' and ENABLE_POWERTOOLS is defined and ENABLE_POWERTOOLS.failed
- name: "Install dependencies: {{ APP_DEPENDENCIES | join(' ') }}"
  package:
    name: "{{ APP_DEPENDENCIES }}"
  become: true
  register: INSTALL_DEPENDENCIES
  ignore_errors: true
- name: "Install dependencies: {{ APP_DEPENDENCIES | join(' ') }}"
  shell: "pkcon install -y {{ item }} | true"
  loop: "{{ APP_DEPENDENCIES }}"
  when: INSTALL_DEPENDENCIES.failed
- name: "Create the directory {{ APP_SRC }}"
  file:
    name: "{{ APP_SRC }}"
    state: directory
- name: "Check for the README file {{ APP_README }}"
  stat:
    path: "{{ APP_README }}"
  register: APP_README_PATH
- name: "Clone the {{ APP_REPO }} source code into {{ APP_SRC }}"
  ansible.builtin.git:
    repo: "{{ APP_REPO }}"
    dest: "{{ APP_SRC }}"
    version: "{{ APP_TAG }}"
    accept_hostkey: true
  when: not APP_README_PATH.stat.exists
- name: "Clone the {{ APP_REPO }} source code into {{ APP_SRC }}"
  ansible.builtin.git:
    repo: "{{ APP_REPO }}"
    dest: "{{ APP_SRC }}"
    version: "{{ APP_TAG }}"
  when: not APP_README_PATH.stat.exists
- name: "Run the autogen.sh script in {{ APP_SRC }}"
  shell:
    cmd: ./autogen.sh
    chdir: "{{ APP_SRC }}"
- name: "Run the configure script in {{ APP_SRC }}"
  shell:
    cmd: "./configure --prefix {{ APP_PREFIX }}"
    chdir: "{{ APP_SRC }}"
- name: "Run the make script in {{ APP_SRC }}"
  shell:
    cmd: make
    chdir: "{{ APP_SRC }}"
- name: "Run the make install script in {{ APP_SRC }}"
  shell:
    cmd: make install
    chdir: "{{ APP_SRC }}"
- name: "Create the launcher {{ APP_DESKTOP }}"
  template:
    src: app.desktop
    dest: "{{ APP_DESKTOP }}"
    mode: 0775

